name: Lipo universal binary on macOS

on:
  workflow_dispatch:

jobs:
  macos-build:
    runs-on: macos-15
    steps:
      - uses: actions/checkout@v4
      - name: Configure
        run: |
          cmake -B build -DCMAKE_VERBOSE_MAKEFILE=on -DCMAKE_OSX_ARCHITECTURES="arm64;x86_64" -DCMAKE_BUILD_TYPE=Build
      - name: Build
        run: |
          cmake --build build
      - name: Look
        run: |
          ls -lR
      - name: Check the file
        run: |
          file build/main
          file build/libmylib.a
          otool -L build/main
      - name: Upload the binary
        uses: actions/upload-artifact@v4
        with:
          name: main
          path: build/main
      - name: Upload the library
        uses: actions/upload-artifact@v4
        with:
          name: mylib
          path: build/libmylib.a
